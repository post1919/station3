<!doctype html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>업무마켓9</title>
	<script type="text/javascript" async="" src="../../js/jquery-3.3.1.min.js"></script>
	<link rel="stylesheet" href="../../css/reset.css" />
	<link rel="stylesheet" href="../../css/layout.css" />
	<link rel="stylesheet" href="../../css/adm.css" />

	<!-- zTree -->
</head>
<body>

<div id="wrap">

</div>

<!--  s : 레이어 팝업 -->
<div class="layer-bg" style="display:;">
	<div class="layer-pop confirm-type" style="">

		<div class="ctit">조직관리 담당자를</div>
		<div class="change-item-wrap">
			<div class="lt-item">
				<div class="cname">김진영 / 총무2팀</div>
				<div class="cemail">jykim@samsung.com</div>
			</div>
			<i class="el-icon-arrow-right"></i>
			<div class="rt-item">
				<div class="cname">박영수 / 총무1팀</div>
				<div class="cemail">yspark@samsung.com</div>
			</div>
		</div>
		<div class="cmsg">으로 변경 하시겠습니까?</div>
		<div class="confirm-btn-wrap">
			<button type="button">아니오</button>
			<button type="button">예</button>
		</div>

		<a href="#" class="pop-close">팝업창 닫기</a>
	</div>


</div>
<!--  e : 레이어 팝업 -->

<!-- zTree -->
<!-- API = http://www.treejs.cn/v3/api.php -->
<link rel="stylesheet" href="../../css/zTree/demo.css" type="text/css">
<link rel="stylesheet" href="../../css/tree/treeStyle/treeStyle.css" type="text/css">
<!--<link rel="stylesheet" href="../css/zTree/zTreeStyle/zTreeStyle.css" type="text/css">-->
<script type="text/javascript" src="../../js/zTree/jquery.ztree.core.js"></script>
<script type="text/javascript" src="../../js/zTree/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="../../js/zTree/jquery.ztree.exedit.js"></script>

<script type="text/javascript">
    var curStatus = "init", curAsyncCount = 0, asyncForAll = false, goAsync = false;
    var log, className = "dark", curDragNodes, autoExpandNode;

    var setting = {
        treeId : "castingn",
        view: {
            addHoverDom: addHoverDom,
            removeHoverDom: removeHoverDom,
            selectedMulti: false,
            expandSpeed:"fast"
        },

        data: {
            simpleData: {
                enable: true
            }
        },
        callback: {
            beforeDrag: beforeDrag,
            beforeDrop: beforeDrop,
            beforeEditName: beforeEditName,
            beforeRemove: beforeRemove,
            beforeRename: beforeRename,
            onRemove: onRemove,
            onRename: onRename,
            onClick: onClick,
            beforeCollapse: beforeCollapse,
            beforeExpand: beforeExpand,
            onCollapse: onCollapse,
            onExpand: onExpand,
            onDrop:onDrop
        },
        check: {
            autoCheckTrigger: false,
            chkboxType: {"Y": "ps", "N":"ps"},
            chkStyle: "checkbox",
            enable: true,
            nocheckInherit: false,
            chkDisabledInherit: true,
            radioType: "level"
        }
    };

    var zNodes =[
        <!-- 1 DEPTH -->
        {
            id        : "1", pId      : 0,                  name         : "삼성전자",      open        : true, nocheck:true
            , AM_PK     : "1",     AM_CODE  : "A",  AM_FULL_NAME : "Home > 삼성전자", AM_AUTH     : "ADMIN",     AM_AUTH2  : "TM"
            , AM_PARENT : "0", AM_DEPTH : "0", AM_IS_MAIN   : "1",   AM_ORDERING : "1", AM_MEMO   : ""
            , AM_URI    : "",    AM_ICON  : "fa fa-smile-o text-yellow",  AM_STATUS    : "1",    AM_INCODE   : "tspark",   AM_INDATE : "2018-09-07 00:00:00.0"



            <!-- 2 DEPTH -->

            , children:[

                {
                    id        : "11", pId : 1, name : "전략기획실"
                    , AM_PK     : "2",     AM_CODE  : "A-01",  AM_FULL_NAME : "Home > 삼성전자 > 전략기획실", AM_AUTH     : "ADMIN",     AM_AUTH2  : "TM"
                    , AM_PARENT : "1", AM_DEPTH : "2", AM_IS_MAIN   : "1",   AM_ORDERING : "1", AM_MEMO   : ""
                    , AM_URI    : "/admin/user/list/all",    AM_ICON  : "fa fa-circle-o",  AM_STATUS    : "1",    AM_INCODE   : "tspark",   AM_INDATE : "2018-09-07 00:00:00.0"



                }
            ]

        }
    ];

    //기본정보 저장/수정
    function fn_default_save(node){
        //console.log("---------------- fn_default_save");
        //console.log(node.getParentNode());

        if( node == null ){

        } else {
            //최상위노드일경우
            if( node.getParentNode() == null){
                var treeObj = $.fn.zTree.getZTreeObj("castingnTree");
                var nodes = treeObj.getNodes();

                console.log("---------------- treeObj.getNodes()");
                //console.log(treeObj.getNodes());

                for( var i=0; i<treeObj.getNodes().length; i++ ){
                    var am_pk       = nodes[i].AM_PK;
                    var am_name     = nodes[i].name;
                    var am_parent   = "0";
                    var am_depth    = "0";
                    var am_ordering = i+1;

                    console.log(i + " = am_pk=>"+am_pk+", am_name=>"+am_name+", am_parent=>"+am_parent + ", am_depth=>"+am_depth + ", am_ordering=>"+am_ordering);

                    var paramData = {
                        "am_pk":am_pk
                        ,"am_name":am_name
                        ,"am_parent":am_parent
                        ,"am_depth":am_depth
                        ,"am_ordering":am_ordering
                    }

                    var data = procAjax("/rest/blog/adminMenuDefaultSave", paramData, false);

                    if(data == "1"){

                        //신규등록일경우 새로생성된 AM_PK 셋팅
                    } else if(data.result == "success_wuth_am_pk"){
                        nodes[i].AM_PK = data.AM_PK;
                        //document.location.reload();
                    } else {
                        alert("오류가 발생했습니다.");
                        //window.close();
                        document.location.reload();
                    }
                }

            } else {
                console.log("----------------node.getParentNode().children");
                //console.log(node.getParentNode().children);

                var parent_am_pk = node.getParentNode().AM_PK;

                var childNodes = node.getParentNode().children;

                for( var i=0; i<childNodes.length; i++ ){

                    var am_pk       = childNodes[i].AM_PK;
                    var am_name     = childNodes[i].name;
                    var am_parent   = parent_am_pk;
                    var am_depth    = childNodes[i].level + 1;
                    var am_ordering = i+1;

                    console.log(i + " = am_name=>"+am_name+ " = am_parent=>"+am_parent + " = am_depth=>"+am_depth + " = am_ordering=>"+am_ordering);

                    var paramData = {
                        "am_pk":am_pk
                        ,"am_name":am_name
                        ,"am_parent":am_parent
                        ,"am_depth":am_depth
                        ,"am_ordering":am_ordering
                    }

                    var data = procAjax("/rest/blog/adminMenuDefaultSave", paramData, false);

                    if(data == "1"){

                        //신규등록일경우 새로생성된 AM_PK 셋팅
                    } else if(data.result == "success_wuth_am_pk"){
                        console.log(childNodes[i].AM_PK);
                        childNodes[i].AM_PK = data.AM_PK;
                        console.log(childNodes[i].AM_PK);
                    } else {
                        alert("오류가 발생했습니다.");
                        //window.close();
                        document.location.reload();
                    }
                }
            }
        }
    }

    //메뉴 클릭했을때
    function onClick(event, treeId, treeNode, clickFlag) {

        //오른쪽 영역에 값들 셋팅
        $("#am_pk").val(treeNode.AM_PK); //순번
        $("#am_pk_txt").text(treeNode.AM_PK); //순번 HIDDEN

        //부모메뉴PK
        $("#am_parent option").each(function(){
            if( $(this).val() == treeNode.AM_PARENT ){
                $(this).prop("selected", "seleted");
            }
        });

        $("#am_code").val(treeNode.AM_CODE); //메뉴코드
        $("#am_name").val(treeNode.name); //메뉴명
        $("#am_full_name").val(treeNode.AM_FULL_NAME); //메뉴명 전체
        $("#am_auth").val(treeNode.AM_AUTH); //권한
        $("#am_auth2").val(treeNode.AM_AUTH2); //권한2
        $("#am_depth").val(treeNode.AM_DEPTH); //메뉴LEVEL
        $("#am_uri").val(treeNode.AM_URI); //URI
        $("#am_is_main").val(treeNode.AM_IS_MAIN); //메인메뉴여부
        $("#am_ordering").val(treeNode.AM_ORDERING); //정렬순서
        $("#am_icon").val(treeNode.AM_ICON); //아이콘명
        $("#am_memo").val(treeNode.AM_MEMO); //메모
        $("#am_status").val(treeNode.AM_STATUS); //상태

        //showLog("[ "+getTime()+" onClick ]&nbsp;&nbsp;event="+event+"&nbsp;treeId="+treeId+"&nbsp;treeNode.tId="+treeNode.tId+"&nbsp;clickFlag="+clickFlag);
    }

    //마우스드래그중
    function beforeDrag(treeId, treeNodes) {
        for (var i=0,l=treeNodes.length; i<l; i++) {
            if (treeNodes[i].drag === false) {
                return false;
            }
        }

        //console.log("===beforeDrag treeNodes===");
        //console.log(treeNodes);

        //showLog("[ "+getTime()+" beforeDrag ]&nbsp;&nbsp;treeId="+treeId+"&nbsp;treeNodes="+treeNodes);

        return true;
    }

    //드래그 후 드롭할때
    function beforeDrop(treeId, treeNodes, targetNode, moveType, isCopy) {

        className = (className === "dark" ? "":"dark");
        //showLog("[ "+getTime()+" beforeDrop ]&nbsp;&nbsp;&nbsp;&nbsp; moveType:" + moveType);
        //showLog("target: " + (targetNode ? targetNode.name : "root") + "  -- is "+ (isCopy==null? "cancel" : isCopy ? "copy" : "move"));
        return true;
    }

    //드래그 후 드롭할때(beforeDrop함수에서 true일때 넘어옴)
    function onDrop(event, treeId, treeNodes, targetNode, moveType, isCopy) {

        //console.log(treeNodes);
        //console.log(targetNode);
        //return false;

        //기본정보 저장/수정
        fn_default_save(treeNodes[0]);

        //className = (className === "dark" ? "":"dark");
        //showLog("[ "+getTime()+" onDrop ]&nbsp;&nbsp;&nbsp;&nbsp; moveType:" + moveType);
        //showLog("target: " + (targetNode ? targetNode.name : "root") + "  -- is "+ (isCopy==null? "cancel" : isCopy ? "copy" : "move"))
    }

    function dropPrev(treeId, nodes, targetNode) {
        var pNode = targetNode.getParentNode();
        if (pNode && pNode.dropInner === false) {
            return false;
        } else {
            for (var i=0,l=curDragNodes.length; i<l; i++) {
                var curPNode = curDragNodes[i].getParentNode();
                if (curPNode && curPNode !== targetNode.getParentNode() && curPNode.childOuter === false) {
                    return false;
                }
            }
        }
        return true;
    }

    function dropInner(treeId, nodes, targetNode) {
        if (targetNode && targetNode.dropInner === false) {
            return false;
        } else {
            for (var i=0,l=curDragNodes.length; i<l; i++) {
                if (!targetNode && curDragNodes[i].dropRoot === false) {
                    return false;
                } else if (curDragNodes[i].parentTId && curDragNodes[i].getParentNode() !== targetNode && curDragNodes[i].getParentNode().childOuter === false) {
                    return false;
                }
            }
        }
        return true;
    }

    function dropNext(treeId, nodes, targetNode) {
        var pNode = targetNode.getParentNode();
        if (pNode && pNode.dropInner === false) {
            return false;
        } else {
            for (var i=0,l=curDragNodes.length; i<l; i++) {
                var curPNode = curDragNodes[i].getParentNode();
                if (curPNode && curPNode !== targetNode.getParentNode() && curPNode.childOuter === false) {
                    return false;
                }
            }
        }
        return true;
    }

    function beforeDrag(treeId, treeNodes) {
        className = (className === "dark" ? "":"dark");
        //showLog("[ "+getTime()+" beforeDrag ]&nbsp;&nbsp;&nbsp;&nbsp; drag: " + treeNodes.length + " nodes." );
        for (var i=0,l=treeNodes.length; i<l; i++) {
            if (treeNodes[i].drag === false) {
                curDragNodes = null;
                return false;
            } else if (treeNodes[i].parentTId && treeNodes[i].getParentNode().childDrag === false) {
                curDragNodes = null;
                return false;
            }
        }
        curDragNodes = treeNodes;
        return true;
    }

    function beforeDragOpen(treeId, treeNode) {
        autoExpandNode = treeNode;
        return true;
    }

    //수정아이콘 클릭시
    function beforeEditName(treeId, treeNode) {
        className = (className === "dark" ? "":"dark");
        //showLog("[ "+getTime()+" beforeEditName ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
        var zTree = $.fn.zTree.getZTreeObj("castingnTree");
        zTree.selectNode(treeNode);
        setTimeout(function() {
            //if (confirm(treeNode.name + "' 수정하시겠습니까?")) {
            setTimeout(function() {
                zTree.editName(treeNode);
            }, 0);
            //}
        }, 0);
        return false;
    }

    //메뉴삭제 아이콘 클릭
    function beforeRemove(treeId, treeNode) {
        className = (className === "dark" ? "":"dark");
        //showLog("[ "+getTime()+" beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
        var zTree = $.fn.zTree.getZTreeObj("castingnTree");
        zTree.selectNode(treeNode);

        if( typeof treeNode.AM_PK == "undefined" ){
            //return면 onRemove호출함
            return true;

        } else {
            //취소아니면 고고
            if( confirm("'" + treeNode.name + "' 삭제하시겠습니까?") ){
                var am_pk       = treeNode.AM_PK;
                var am_name     = treeNode.name;
                var am_delflag  = "0"; //사용 1, 삭제 0

                console.log("am_pk=>"+am_pk);

                var paramData = {
                    "am_pk"      : am_pk,
                    "am_delflag" : am_delflag
                }

                var successFlag = procAjax("/rest/blog/adminMenuDelete", paramData, false);

                //정상적으로 이벤트 신청완료 되었을 경우 완료 메세지 띄움
                if(successFlag == 1){

                }else if(successFlag == 5){
                    alert("실패");
                    //window.close();
                } else if(successFlag == 9){//이미 등록되어있는 경우
                    alert("이미 등록되었습니다.");
                    //window.close();
                } else {
                    alert("오류가 발생했습니다.");
                    //window.close();
                    document.location.reload();
                }

                return true;

            } else {
                return false;
            }
        }
    }

    function onRemove(e, treeId, treeNode) {
        //showLog("[ "+getTime()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
    }

    function beforeRename(treeId, treeNode, newName, isCancel) {
        className = (className === "dark" ? "":"dark");
        //showLog((isCancel ? "<span style='color:red'>":"") + "[ "+getTime()+" beforeRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>":""));
        if (newName.length == 0) {
            setTimeout(function() {
                var zTree = $.fn.zTree.getZTreeObj("castingnTree");
                zTree.cancelEditName();
                alert("Node name can not be empty.");
            }, 0);
            return false;
        }

        //메뉴명이 바뀐경우만 고고
        if( treeNode.name != newName ){
            fn_name_update(treeNode, newName);
        }

        return true;
    }

    //메뉴명 수정
    function fn_name_update(treeNode, newName){
        var am_pk       = treeNode.AM_PK;
        var am_name     = newName;

        console.log("am_pk=>"+am_pk+", am_name=>"+am_name);

        var paramData = {
            "am_pk"   : am_pk
            , "am_name" : am_name
        }

        var successFlag = procAjax("/rest/blog/adminMenuNameSave", paramData, false);

        //정상적으로 이벤트 신청완료 되었을 경우 완료 메세지 띄움
        if(successFlag == 1){

        }else if(successFlag == 5){
            alert("실패");
            //window.close();
        } else if(successFlag == 9){//이미 등록되어있는 경우
            alert("이미 등록되었습니다.");
            //window.close();
        } else {
            alert("오류가 발생했습니다.");
            //window.close();
            document.location.reload();
        }
    }

    //메뉴명 변경한후(엔터)
    function onRename(e, treeId, treeNode, isCancel) {
        //console.log(treeNode);
        //showLog((isCancel ? "<span style='color:red'>":"") + "[ "+getTime()+" onRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>":""));
    }

    function showRemoveBtn(treeId, treeNode) {
        return true;
        //return !treeNode.isFirstNode;
    }

    function showRenameBtn(treeId, treeNode) {
        return true;
        //return !treeNode.isLastNode;
    }

    function beforeCollapse(treeId, treeNode) {
        className = (className === "dark" ? "":"dark");
        //showLog("[ "+getTime()+" beforeCollapse ]&nbsp;&nbsp;&nbsp;&nbsp;" + treeNode.name );
        return (treeNode.collapse !== false);
    }

    function onCollapse(event, treeId, treeNode) {
        //showLog("[ "+getTime()+" onCollapse ]&nbsp;&nbsp;&nbsp;&nbsp;" + treeNode.name);
    }

    function beforeExpand(treeId, treeNode) {
        className = (className === "dark" ? "":"dark");
        //showLog("[ "+getTime()+" beforeExpand ]&nbsp;&nbsp;&nbsp;&nbsp;" + treeNode.name );
        return (treeNode.expand !== false);
    }

    function onExpand(event, treeId, treeNode) {
        //showLog("[ "+getTime()+" onExpand ]&nbsp;&nbsp;&nbsp;&nbsp;" + treeNode.name);
    }

    function expandNodes(nodes) {
        if (!nodes) return;
        curStatus = "expand";
        var zTree = $.fn.zTree.getZTreeObj("castingnTree");
        for (var i=0, l=nodes.length; i<l; i++) {
            zTree.expandNode(nodes[i], true, false, false);
            if (nodes[i].isParent && nodes[i].zAsync) {
                expandNodes(nodes[i].children);
            } else {
                goAsync = true;
            }
        }
    }

    function reset() {
        if (!check()) {
            return;
        }
        asyncForAll = false;
        goAsync = false;
        //$("#demoMsg").text("");
        $.fn.zTree.init($("#castingnTree"), setting);
    }

    function check() {
        if (curAsyncCount > 0) {
            //	$("#demoMsg").text(demoMsg.async);
            return false;
        }
        return true;
    }

    function showLog(str) {
        if (!log) log = $("#log");
        log.append("<li class='"+className+"'>"+str+"</li>");
        if(log.children("li").length > 8) {
            log.get(0).removeChild(log.children("li")[0]);
        }
    }

    function getTime() {
        var now= new Date(),
            h=now.getHours(),
            m=now.getMinutes(),
            s=now.getSeconds(),
            ms=now.getMilliseconds();
        return (h+":"+m+":"+s+ " " +ms);
    }

    var newCount = 1;

    function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span");
        if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
        var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
            + "' title='add node' onfocus='this.blur();'></span>";
        sObj.after(addStr);
        var btn = $("#addBtn_"+treeNode.tId);

        //아이콘눌러서 노드추가
        if (btn) btn.bind("click", function(){
            //console.log("=======Add Menu =======")
            //console.log(treeNode);

            if( treeNode.level >= 2 ){
                alert("3 DEPTH이상은 만들수 없습니다.");
                return false;
            }

            var zTree = $.fn.zTree.getZTreeObj("castingnTree");
            var newNode = zTree.addNodes(treeNode, {id:(100 + newCount), pId:treeNode.id, name:"new node" + (newCount++)} );

            //console.log(newNode[0]);

            //기본정보 저장/수정
            fn_default_save(newNode[0]);

            return false;
        });
    };

    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_"+treeNode.tId).unbind().remove();
    };

    function selectAll() {
        var zTree = $.fn.zTree.getZTreeObj("castingnTree");
        zTree.setting.edit.editNameSelectAll =  $("#selectAll").attr("checked");
    }

    function expandNode(e) {
        var zTree = $.fn.zTree.getZTreeObj("castingnTree"),
            type = e.data.type,
            nodes = zTree.getSelectedNodes();
        if (type.indexOf("All")<0 && nodes.length == 0) {
            alert("Please select one parent node at first...");
        }

        if (type == "expandAll") {
            zTree.expandAll(true);
        } else if (type == "collapseAll") {
            zTree.expandAll(false);
        } else {
            var callbackFlag = $("#callbackTrigger").attr("checked");
            for (var i=0, l=nodes.length; i<l; i++) {
                zTree.setting.view.fontCss = {};
                if (type == "expand") {
                    zTree.expandNode(nodes[i], true, null, null, callbackFlag);
                } else if (type == "collapse") {
                    zTree.expandNode(nodes[i], false, null, null, callbackFlag);
                } else if (type == "toggle") {
                    zTree.expandNode(nodes[i], null, null, null, callbackFlag);
                } else if (type == "expandSon") {
                    zTree.expandNode(nodes[i], true, true, null, callbackFlag);
                } else if (type == "collapseSon") {
                    zTree.expandNode(nodes[i], false, true, null, callbackFlag);
                }
            }
        }
    }

    $(document).ready(function(){
        $.fn.zTree.init($("#castingnTree"), setting, zNodes);

        //초기 전체 닫음
        $.fn.zTree.getZTreeObj("castingnTree").expandAll(false);

        //전체 펼치기
        $("#expandAllBtn").bind("click", {type:"expandAll"}, expandNode);

        //전체 닫기
        $("#collapseAllBtn").bind("click", {type:"collapseAll"}, expandNode);

        $("#selectAll").bind("click", selectAll);
    });

</script>
<!--// zTree -->

</body>
</html>





